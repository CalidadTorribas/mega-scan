<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega||Scan - Esc√°ner de C√≥digos de Barras</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1E40AF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mega||Scan">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = { 
                darkMode: 'media',
                theme: {
                    extend: {
                        fontFamily: {
                            'inter': ['Inter', 'system-ui', 'sans-serif']
                        }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- M√≥dulos de la aplicaci√≥n h√≠brida (v2.0) -->
    <!-- Interfaces y detecci√≥n de capacidades -->
    <script src="scanner-interfaces.js"></script>
    
    <!-- Motores de escaneo -->
    <script src="barcode-detector-engine.js"></script>
    <script src="zxing-wasm-engine.js"></script>
    <script src="html5-qrcode-engine.js"></script>
    
    <!-- Factory orquestadora -->
    <script src="scanner-factory.js"></script>
    
    <!-- M√≥dulo principal actualizado -->
    <script src="scanner-module.js"></script>
    <script src="view-manager.js"></script>

    <style>
        * {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        .scanner-overlay {
            background: linear-gradient(45deg, transparent 30%, rgba(59, 130, 246, 0.1) 50%, transparent 70%);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }

        .focus-ring:focus {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }

        .pulse-button {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-white to-blue-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 transition-colors duration-500 font-inter">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-center text-white">
            <div class="mb-6">
                <svg class="w-24 h-24 mx-auto mb-4 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 5v14M8 5v14M12 5v14M17 5v14M21 5v14"/>
                </svg>
            </div>
            <h1 class="text-4xl font-bold mb-2">Mega||Scan</h1>
            <p class="text-blue-100 text-lg">Cargando...</p>
        </div>
    </div>

    <main id="app-root" class="w-full max-w-lg mx-auto bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm min-h-screen md:min-h-[95vh] md:my-4 md:shadow-2xl md:rounded-3xl flex flex-col overflow-hidden border border-white/30 dark:border-slate-700/50">
        <!-- El contenido se inyectar√° aqu√≠ -->
    </main>

    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // --- CONFIGURACI√ìN ---
        const APP_CONFIG = {
            VERSION: '2.0.0', // ACTUALIZADO: Nueva versi√≥n con arquitectura h√≠brida
            NAME: 'Mega||Scan',
            DESCRIPTION: 'La forma m√°s r√°pida de obtener informaci√≥n de cualquier producto - Ahora con motores de alto rendimiento'
        };

        const SUPABASE_URL = 'https://srsedippxqjpetcfcaae.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyc2VkaXBweHFqcGV0Y2ZjYWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MjM0OTUsImV4cCI6MjA3MTA5OTQ5NX0.IoLvEbciO1u3UqEZcZhmgaSNYixlI8Thp75K_7CBGhw';
       
        let supabaseClient = null;
        
        // Inicializar Supabase
        if (SUPABASE_URL && SUPABASE_ANON_KEY && typeof supabase !== 'undefined') {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (error) {
                console.error('Error inicializando Supabase:', error);
            }
        }

        // --- ESTADO DE LA APLICACI√ìN ---
        let appState = 'HOME';
        let scannedProduct = null;
        let productMaterials = null;
        let scanner = null; // Instancia del m√≥dulo scanner
        let viewManager = null; // Instancia del ViewManager
        let lastScannedBarcode = null; // NUEVO: Para recordar el √∫ltimo c√≥digo escaneado

        const appRoot = document.getElementById('app-root');

        // --- FUNCIONES AUXILIARES MEJORADAS ---
        function showNotification(message, type = 'info') {
            // MEJORADO: Solo mostrar notificaciones cr√≠ticas
            const criticalMessages = ['error', 'denegado', 'bloqueado', 'adblocker', 'conexi√≥n', 'red'];
            const isCritical = criticalMessages.some(keyword => message.toLowerCase().includes(keyword));
            
            if (!isCritical && type !== 'error') {
                console.log('üì¢ Notificaci√≥n omitida (no cr√≠tica):', message);
                return; // No mostrar notificaciones no cr√≠ticas
            }
            
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500 text-white' : 
                           type === 'success' ? 'bg-green-500 text-white' : 
                           'bg-blue-500 text-white';
            
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 p-4 rounded-xl shadow-lg transition-all duration-300 ${bgColor} max-w-sm text-center text-sm`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // --- GESTI√ìN DE ESTADO Y NAVEGACI√ìN ---
        function render() {
            try {
                let viewData = {};
                
                // Preparar datos seg√∫n el estado
                switch (appState) {
                    case 'SCANNER':
                        const scannerStatus = scanner ? scanner.getStatus() : { cameraPermissionStatus: 'unknown' };
                        // MEJORADO: Pasar informaci√≥n de errores para detecci√≥n de escritorio
                        if (scanner && scanner.lastErrorMessage) {
                            scannerStatus.lastErrorMessage = scanner.lastErrorMessage;
                        }
                        viewData.scannerStatus = scannerStatus;
                        break;
                    case 'LOADING':
                        viewData.message = 'Buscando producto...';
                        break;
                    case 'PRODUCT':
                        if (!scannedProduct) {
                            appState = 'HOME';
                            render();
                            return;
                        }
                        viewData.product = scannedProduct;
                        break;
                    case 'MATERIALS':
                        if (!scannedProduct || productMaterials === null) {
                            appState = 'PRODUCT';
                            render();
                            return;
                        }
                        viewData.product = scannedProduct;
                        viewData.materials = productMaterials;
                        break;
                    case 'PRODUCT_NOT_FOUND': // NUEVO estado
                        viewData.barcode = lastScannedBarcode;
                        break;
                    case 'ERROR':
                        viewData.message = 'Error t√©cnico inesperado';
                        break;
                }
                
                // Renderizar usando ViewManager
                appRoot.innerHTML = viewManager.render(appState, viewData);
                
                // Post-render logic para scanner
                if (appState === 'SCANNER' && scanner) {
                    const status = scanner.getStatus();
                    if (status.cameraPermissionStatus === 'granted' && status.hasRequestedPermissionBefore) {
                        setTimeout(() => scanner.initializeScanner(), 300);
                    }
                }
                
            } catch (error) {
                console.error('Error en render:', error);
                appRoot.innerHTML = viewManager.render('ERROR', { message: 'Error inesperado en la aplicaci√≥n' });
            }
        }

        // --- GESTI√ìN DE EVENTOS ---
        async function handleEvents(event) {
            const action = event.target.closest('[data-action]')?.getAttribute('data-action');
            if (!action) return;

            event.preventDefault();

            try {
                switch (action) {
                    case 'navigate-scanner':
                        appState = 'SCANNER';
                        render();
                        break;
                    case 'activate-camera':
                        await activateCamera();
                        break;
                    case 'go-home':
                        stopScanner();
                        appState = 'HOME';
                        scannedProduct = null;
                        productMaterials = null;
                        lastScannedBarcode = null; // NUEVO: Limpiar √∫ltimo c√≥digo
                        render();
                        break;
                    case 'back-to-product':
                        appState = 'PRODUCT';
                        render();
                        break;
                    case 'view-materials':
                        if (scannedProduct) {
                            loadProductMaterials(scannedProduct.id);
                        }
                        break;
                    case 'manual-submit':
                        handleManualSubmit(event);
                        break;
                }
            } catch (error) {
                console.error('Error manejando evento:', error);
                showNotification('Error procesando la acci√≥n', 'error');
            }
        }

        async function activateCamera() {
            try {
                await scanner.activateCamera();
                
                // Actualizar la vista para mostrar el esc√°ner
                render();
                
                // Inicializar el esc√°ner despu√©s de actualizar la vista
                setTimeout(() => {
                    scanner.initializeScanner();
                }, 500);
                
            } catch (error) {
                // MEJORADO: Capturar mensaje de error espec√≠fico
                const errorMessage = scanner.getErrorMessage(error);
                scanner.lastErrorMessage = errorMessage;
                
                // NUEVO: Si es escritorio sin c√°mara, mantener en vista scanner con mensaje
                if (error.message === 'DESKTOP_NO_CAMERA' || errorMessage.includes('No se detect√≥ ninguna c√°mara en este dispositivo')) {
                    console.log('üñ•Ô∏è Escritorio sin c√°mara detectado, mostrando input manual');
                    // Actualizar scanner status para mostrar mensaje amigable
                    scanner.cameraPermissionStatus = 'desktop_no_camera';
                    render(); // Re-renderizar scanner con mensaje de escritorio
                    return;
                }
                
                // Para otros errores t√©cnicos, ir a pantalla de error
                setTimeout(() => {
                    appState = 'ERROR';
                    appRoot.innerHTML = viewManager.render('ERROR', { message: errorMessage });
                }, 2000);
            }
        }

        function handleManualSubmit(event) {
            event.preventDefault();
            const input = document.getElementById('barcode-input');
            const barcode = input?.value?.trim();
            
            if (!barcode) {
                showNotification('Por favor introduce un c√≥digo', 'error');
                return;
            }

            stopScanner();
            searchProduct(barcode);
            input.value = '';
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop();
            }
        }

        // --- FUNCIONES DE B√öSQUEDA MEJORADAS ---
        async function searchProduct(barcode) {
            appState = 'LOADING';
            lastScannedBarcode = barcode; // NUEVO: Recordar el c√≥digo escaneado
            render();

            try {
                if (!supabaseClient) {
                    throw new Error('Base de datos no configurada');
                }

                const cleanBarcode = String(barcode).trim();
                console.log('üîç Buscando producto con c√≥digo:', cleanBarcode);

                const { data, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('Barcode', cleanBarcode)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    scannedProduct = {
                        ...data,
                        Code: data.Barcode,
                        Name: data.Name,
                        Description: data.Description,
                        image_url: data.image_url,
                        Status: data.Status || 'Activo'
                    };
                    appState = 'PRODUCT';
                    // ELIMINADO: showNotification('Producto encontrado', 'success');
                    console.log('‚úÖ Producto encontrado:', scannedProduct);
                } else {
                    // CAMBIADO: Usar estado PRODUCT_NOT_FOUND en lugar de ERROR
                    appState = 'PRODUCT_NOT_FOUND';
                    // ELIMINADO: showNotification('Producto no encontrado', 'error');
                    console.log('‚ùå Producto no encontrado para c√≥digo:', cleanBarcode);
                }
                
                render();
            } catch (error) {
                console.error('Error buscando producto:', error);
                appState = 'ERROR';
                render();
                showNotification('Error en la b√∫squeda', 'error'); // MANTENIDO: Error cr√≠tico
            }
        }

        async function loadProductMaterials(productId) {
            try {
                appState = 'LOADING';
                render();

                if (!supabaseClient) {
                    throw new Error('Base de datos no configurada');
                }

                console.log('üîç Buscando materiales para producto ID:', productId);

                const { data, error } = await supabaseClient
                    .from('product_materials')
                    .select(`
                        material_id,
                        materials (
                            id,
                            description
                        )
                    `)
                    .eq('product_id', productId);

                if (error) {
                    throw error;
                }

                productMaterials = data ? data.map(item => ({
                    id: item.materials.id,
                    Description: item.materials.description
                })) : [];

                appState = 'MATERIALS';
                render();
                
                // ELIMINADO: Notificaci√≥n de materiales encontrados (redundante)
                const count = productMaterials.length;
                console.log(`‚úÖ ${count} material${count !== 1 ? 'es' : ''} encontrado${count !== 1 ? 's' : ''}:`, productMaterials);
            } catch (error) {
                console.error('Error cargando materiales:', error);
                productMaterials = [];
                appState = 'MATERIALS';
                render();
                showNotification('Error cargando materiales', 'error'); // MANTENIDO: Error cr√≠tico
            }
        }

        // --- INICIALIZACI√ìN ---
        function hideSplashScreen() {
            const splash = document.getElementById('splash-screen');
            if (splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.remove(), 500);
            }
        }

        async function initApp() {
            console.log('üöÄ Inicializando aplicaci√≥n...');
            
            // Inicializar ViewManager
            viewManager = new ViewManager(APP_CONFIG);
            
            // Crear instancia del esc√°ner
            scanner = new ScannerModule();
            
            // Configurar callbacks MEJORADOS con arquitectura h√≠brida
            scanner.setCallbacks({
                onScanSuccess: (decodedText, decodedResult) => {
                    console.log('üéØ Escaneo exitoso con:', decodedResult.engine || 'motor desconocido');
                    searchProduct(decodedText);
                },
                onScanError: (error, message) => {
                    // Solo notificar errores cr√≠ticos
                    if (message.includes('adblocker') || message.includes('conexi√≥n') || message.includes('permisos')) {
                        showNotification(message, 'error');
                    }
                },
                onStatusUpdate: (message) => {
                    const statusElement = document.getElementById('scanner-status');
                    if (statusElement) {
                        statusElement.textContent = message;
                    }
                },
                onPermissionChange: (status) => {
                    console.log('Permisos cambiaron a:', status);
                    if (appState === 'SCANNER') {
                        render();
                    }
                }
            });
            
            // MEJORADO: Verificar permisos persistentes al inicio
            await scanner.checkPersistedPermissions();
            
            setTimeout(hideSplashScreen, 1500);
            render();
            
            document.addEventListener('click', handleEvents);
            document.addEventListener('submit', handleEvents);
            
            window.addEventListener('popstate', () => {
                stopScanner();
                appState = 'HOME';
                render();
            });
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopScanner();
                }
            });
            
            // Limpiar recursos al cerrar la p√°gina
            window.addEventListener('beforeunload', () => {
                if (scanner) {
                    scanner.destroy();
                }
            });
            
            console.log('‚úÖ Aplicaci√≥n inicializada con arquitectura h√≠brida v2.0');
            
            // Debug visual mejorado para desarrollo
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                console.log('üõ†Ô∏è MODO DEBUG ACTIVADO - Informaci√≥n detallada disponible');
                
                // Mostrar informaci√≥n del motor disponible
                setTimeout(async () => {
                    try {
                        const engineInfo = scanner.getEngineInfo();
                        if (engineInfo) {
                            console.log('üîß Motor de escaneo disponible:', engineInfo.name);
                            console.log('‚ö° Rendimiento estimado:', engineInfo.performance);
                            console.log('üìã Capacidades:', engineInfo.capabilities);
                            
                            // Mostrar estad√≠sticas de la factory
                            const factoryStats = scanner.scannerFactory?.getStats();
                            if (factoryStats) {
                                console.log('üìä Factory Stats:', factoryStats);
                            }
                            
                            // A√±adir indicador visual en la UI
                            const debugIndicator = document.createElement('div');
                            debugIndicator.innerHTML = `
                                <div style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 8px; font-family: monospace; font-size: 12px; z-index: 9999; max-width: 200px;">
                                    <div style="color: #4ade80;">üîß ${engineInfo.name}</div>
                                    <div style="color: #60a5fa;">‚ö° ${engineInfo.performance}</div>
                                    <div style="color: #fbbf24;">üì± ${navigator.userAgent.includes('Mobile') ? 'M√≥vil' : 'Escritorio'}</div>
                                </div>
                            `;
                            document.body.appendChild(debugIndicator);
                            
                            // Auto-ocultar despu√©s de 5 segundos
                            setTimeout(() => {
                                debugIndicator.style.opacity = '0.3';
                            }, 5000);
                        }
                    } catch (e) {
                        console.log('‚ÑπÔ∏è Informaci√≥n del motor disponible despu√©s de la primera inicializaci√≥n');
                    }
                }, 2000);
                
                // Funci√≥n de debug global
                window.debugMegaScan = () => {
                    console.log('=== üõ†Ô∏è MEGA SCAN DEBUG INFO ===');
                    console.log('Motor actual:', scanner.getEngineInfo());
                    console.log('Estado:', scanner.getStatus());
                    console.log('Estad√≠sticas:', scanner.getDetailedStats());
                    if (scanner.scannerFactory?.capabilityDetector) {
                        console.log('Capacidades:', scanner.scannerFactory.capabilityDetector.getCapabilities());
                    }
                    console.log('=== FIN DEBUG INFO ===');
                };
                
                console.log('üí° Tip: Ejecuta debugMegaScan() en consola para informaci√≥n completa');
            } else {
                // Log informaci√≥n b√°sica en producci√≥n
                setTimeout(async () => {
                    try {
                        const engineInfo = scanner.getEngineInfo();
                        if (engineInfo) {
                            console.log('üîß Motor de escaneo disponible:', engineInfo.name);
                            console.log('‚ö° Rendimiento estimado:', engineInfo.performance);
                        }
                    } catch (e) {
                        console.log('‚ÑπÔ∏è Informaci√≥n del motor disponible despu√©s de la primera inicializaci√≥n');
                    }
                }, 1000);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>