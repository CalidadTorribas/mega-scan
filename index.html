<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega||Scan - Esc√°ner de C√≥digos de Barras</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1E40AF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mega||Scan">
    <link rel="manifest" href="public/manifest.json">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Design System v3.0 - CSS en orden correcto -->
    <link rel="stylesheet" href="src/styles/design-tokens/colors.css">
    <link rel="stylesheet" href="src/styles/design-tokens/typography.css">
    <link rel="stylesheet" href="src/styles/design-tokens/spacing.css">
    <link rel="stylesheet" href="src/styles/design-tokens/effects.css">
    <link rel="stylesheet" href="src/styles/base/reset.css">
    <link rel="stylesheet" href="src/styles/base/globals.css">
    <link rel="stylesheet" href="src/styles/base/components.css">
    <link rel="stylesheet" href="src/styles/themes/light.css">
    <link rel="stylesheet" href="src/styles/themes/dark.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Core Scanner System v2.1 -->
    <script src="src/core/scanner/scanner-interfaces.js"></script>
    <script src="src/core/scanner/barcode-detector-engine.js"></script>
    <script src="src/core/scanner/zxing-wasm-engine.js"></script>
    <script src="src/core/scanner/html5-qrcode-engine.js"></script>
    <script src="src/core/scanner/scanner-factory.js"></script>
    <script src="src/core/scanner/scanner-module.js"></script>
    
    <!-- UI System v3.0 -->
    <script src="src/utils/IconManager.js"></script>
    <script src="src/ui/components/buttons/Button.js"></script>
    <script src="src/ui/components/layout/Card.js"></script>
    <script src="src/ui/components/layout/Header.js"></script>
    <script src="src/ui/view-manager.js"></script>

    <style>
        /* Estilos espec√≠ficos de la aplicaci√≥n */
        .app-layout {
            min-height: 100vh;
            background: var(--gradient-app-bg);
            position: relative;
        }

        .app-content {
            width: 100%;
            max-width: 32rem;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }

        @media (min-width: 768px) {
            .app-content {
                min-height: 95vh;
                margin: 2vh auto;
                border-radius: var(--radius-3xl);
                box-shadow: var(--shadow-2xl);
                border: 1px solid rgba(255, 255, 255, 0.3);
            }
        }

        /* Estilos espec√≠ficos del scanner */
        .scanner-overlay {
            background: linear-gradient(45deg, transparent 30%, rgba(59, 130, 246, 0.1) 50%, transparent 70%);
            animation: scan 2s linear infinite;
        }
        
        /* Splash screen espec√≠fico */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            transition: opacity var(--duration-slow) var(--ease-out);
        }

        .splash-content {
            text-align: center;
            color: white;
        }

        .splash-logo {
            width: 6rem;
            height: 6rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-3xl);
            backdrop-filter: blur(8px);
            margin: 0 auto var(--spacing-6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
        }

        .splash-title {
            font-size: var(--text-4xl);
            font-weight: var(--font-extrabold);
            margin: 0 0 var(--spacing-2) 0;
            letter-spacing: -0.025em;
        }

        .splash-subtitle {
            font-size: var(--text-lg);
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        /* Focus ring mejorado */
        .focus-ring:focus-visible {
            outline: 2px solid var(--color-primary-500);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="font-primary" data-theme="light">

    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen fade-in">
        <div class="splash-content">
            <div class="splash-logo">
                <span style="color: var(--color-primary-300);">M</span>
                <span style="color: var(--color-primary-200); margin: 0 var(--spacing-1);">||</span>
                <span style="color: var(--color-primary-100);">S</span>
            </div>
            <h1 class="splash-title">Mega||Scan</h1>
            <p class="splash-subtitle">Cargando sistema h√≠brido...</p>
        </div>
    </div>

    <main id="app-root" class="app-layout">
        <div class="app-content">
            <!-- El contenido se inyectar√° aqu√≠ -->
        </div>
    </main>

    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./public/sw.js')
                    .then(registration => console.log('‚úÖ SW registered'))
                    .catch(error => console.log('‚ùå SW registration failed:', error));
            });
        }

        // --- CONFIGURACI√ìN ---
        const APP_CONFIG = {
            VERSION: '3.0.0', // ACTUALIZADO: Nueva versi√≥n con Design System
            NAME: 'Mega||Scan',
            DESCRIPTION: 'La forma m√°s r√°pida de obtener informaci√≥n de cualquier producto - Ahora con Design System v3.0'
        };

        const SUPABASE_URL = 'https://srsedippxqjpetcfcaae.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyc2VkaXBweHFqcGV0Y2ZjYWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MjM0OTUsImV4cCI6MjA3MTA5OTQ5NX0.IoLvEbciO1u3UqEZcZhmgaSNYixlI8Thp75K_7CBGhw';
       
        let supabaseClient = null;
        
        // Inicializar Supabase
        if (SUPABASE_URL && SUPABASE_ANON_KEY && typeof supabase !== 'undefined') {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (error) {
                console.error('Error inicializando Supabase:', error);
            }
        }

        // --- ESTADO DE LA APLICACI√ìN ---
        let appState = 'HOME';
        let scannedProduct = null;
        let productMaterials = null;
        let scanner = null;
        let viewManager = null;
        let lastScannedBarcode = null;
        
        // NUEVO: Instancias del Design System
        let iconManager = null;
        let button = null;
        let card = null;
        let header = null;

        const appRoot = document.getElementById('app-root').querySelector('.app-content');

        // --- FUNCIONES AUXILIARES MEJORADAS ---
        function showNotification(message, type = 'info') {
            // Usar nuevo sistema de notificaciones (implementaremos despu√©s)
            const criticalMessages = ['error', 'denegado', 'bloqueado', 'adblocker', 'conexi√≥n', 'red'];
            const isCritical = criticalMessages.some(keyword => message.toLowerCase().includes(keyword));
            
            if (!isCritical && type !== 'error') {
                console.log('üì¢ Notificaci√≥n omitida (no cr√≠tica):', message);
                return;
            }
            
            // Implementaci√≥n temporal - mejoraremos con componentes
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? 'var(--color-error-500)' : 
                           type === 'success' ? 'var(--color-success-500)' : 
                           'var(--color-info-500)';
            
            notification.style.cssText = `
                position: fixed;
                top: var(--spacing-4);
                left: 50%;
                transform: translateX(-50%);
                z-index: var(--z-toast);
                padding: var(--spacing-4);
                border-radius: var(--radius-xl);
                box-shadow: var(--shadow-lg);
                background: ${bgColor};
                color: white;
                max-width: 20rem;
                text-align: center;
                font-size: var(--text-sm);
                font-weight: var(--font-medium);
                transition: all var(--duration-normal) var(--ease-out);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // --- GESTI√ìN DE ESTADO Y NAVEGACI√ìN ---
        function render() {
            try {
                let viewData = {};
                
                // Preparar datos seg√∫n el estado
                switch (appState) {
                    case 'SCANNER':
                        const scannerStatus = scanner ? scanner.getStatus() : { cameraPermissionStatus: 'unknown' };
                        if (scanner && scanner.lastErrorMessage) {
                            scannerStatus.lastErrorMessage = scanner.lastErrorMessage;
                        }
                        viewData.scannerStatus = scannerStatus;
                        break;
                    case 'LOADING':
                        viewData.message = 'Buscando producto...';
                        break;
                    case 'PRODUCT':
                        if (!scannedProduct) {
                            appState = 'HOME';
                            render();
                            return;
                        }
                        viewData.product = scannedProduct;
                        break;
                    case 'MATERIALS':
                        if (!scannedProduct || productMaterials === null) {
                            appState = 'PRODUCT';
                            render();
                            return;
                        }
                        viewData.product = scannedProduct;
                        viewData.materials = productMaterials;
                        break;
                    case 'PRODUCT_NOT_FOUND':
                        viewData.barcode = lastScannedBarcode;
                        break;
                    case 'ERROR':
                        viewData.message = 'Error t√©cnico inesperado';
                        break;
                }
                
                // Renderizar usando ViewManager
                appRoot.innerHTML = viewManager.render(appState, viewData);
                
                // Post-render logic para scanner
                if (appState === 'SCANNER' && scanner) {
                    const status = scanner.getStatus();
                    if (status.cameraPermissionStatus === 'granted' && status.hasRequestedPermissionBefore) {
                        setTimeout(() => scanner.initializeScanner(), 300);
                    }
                }
                
            } catch (error) {
                console.error('Error en render:', error);
                appRoot.innerHTML = viewManager.render('ERROR', { message: 'Error inesperado en la aplicaci√≥n' });
            }
        }

        // --- GESTI√ìN DE EVENTOS ---
        async function handleEvents(event) {
            const action = event.target.closest('[data-action]')?.getAttribute('data-action');
            if (!action) return;

            event.preventDefault();

            try {
                switch (action) {
                    case 'navigate-scanner':
                        appState = 'SCANNER';
                        render();
                        break;
                    case 'activate-camera':
                        await activateCamera();
                        break;
                    case 'go-home':
                        stopScanner();
                        appState = 'HOME';
                        scannedProduct = null;
                        productMaterials = null;
                        lastScannedBarcode = null;
                        render();
                        break;
                    case 'go-back':
                        // L√≥gica de navegaci√≥n hacia atr√°s
                        if (appState === 'MATERIALS') {
                            appState = 'PRODUCT';
                        } else if (appState === 'PRODUCT' || appState === 'SCANNER') {
                            appState = 'HOME';
                        }
                        render();
                        break;
                    case 'back-to-product':
                        appState = 'PRODUCT';
                        render();
                        break;
                    case 'view-materials':
                        if (scannedProduct) {
                            loadProductMaterials(scannedProduct.id);
                        }
                        break;
                    case 'manual-submit':
                        handleManualSubmit(event);
                        break;
                    case 'reload-page':
                        location.reload();
                        break;
                }
            } catch (error) {
                console.error('Error manejando evento:', error);
                showNotification('Error procesando la acci√≥n', 'error');
            }
        }

        async function activateCamera() {
            try {
                await scanner.activateCamera();
                render();
                setTimeout(() => {
                    scanner.initializeScanner();
                }, 500);
            } catch (error) {
                const errorMessage = scanner.getErrorMessage(error);
                scanner.lastErrorMessage = errorMessage;
                
                if (error.message === 'DESKTOP_NO_CAMERA' || errorMessage.includes('No se detect√≥ ninguna c√°mara en este dispositivo')) {
                    console.log('üñ•Ô∏è Escritorio sin c√°mara detectado, mostrando input manual');
                    scanner.cameraPermissionStatus = 'desktop_no_camera';
                    render();
                    return;
                }
                
                setTimeout(() => {
                    appState = 'ERROR';
                    appRoot.innerHTML = viewManager.render('ERROR', { message: errorMessage });
                }, 2000);
            }
        }

        function handleManualSubmit(event) {
            event.preventDefault();
            const input = document.getElementById('barcode-input');
            const barcode = input?.value?.trim();
            
            if (!barcode) {
                showNotification('Por favor introduce un c√≥digo', 'error');
                return;
            }

            stopScanner();
            searchProduct(barcode);
            input.value = '';
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop();
            }
        }

        // --- FUNCIONES DE B√öSQUEDA MEJORADAS ---
        async function searchProduct(barcode) {
            appState = 'LOADING';
            lastScannedBarcode = barcode;
            render();

            try {
                if (!supabaseClient) {
                    throw new Error('Base de datos no configurada');
                }

                const cleanBarcode = String(barcode).trim();
                console.log('üîç Buscando producto con c√≥digo:', cleanBarcode);

                const { data, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .eq('Barcode', cleanBarcode)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data) {
                    scannedProduct = {
                        ...data,
                        Code: data.Barcode,
                        Name: data.Name,
                        Description: data.Description,
                        image_url: data.image_url,
                        Status: data.Status || 'Activo'
                    };
                    appState = 'PRODUCT';
                    console.log('‚úÖ Producto encontrado:', scannedProduct);
                } else {
                    appState = 'PRODUCT_NOT_FOUND';
                    console.log('‚ùå Producto no encontrado para c√≥digo:', cleanBarcode);
                }
                
                render();
            } catch (error) {
                console.error('Error buscando producto:', error);
                appState = 'ERROR';
                render();
                showNotification('Error en la b√∫squeda', 'error');
            }
        }

        async function loadProductMaterials(productId) {
            try {
                appState = 'LOADING';
                render();

                if (!supabaseClient) {
                    throw new Error('Base de datos no configurada');
                }

                console.log('üîç Buscando materiales para producto ID:', productId);

                const { data, error } = await supabaseClient
                    .from('product_materials')
                    .select(`
                        material_id,
                        materials (
                            id,
                            description
                        )
                    `)
                    .eq('product_id', productId);

                if (error) {
                    throw error;
                }

                productMaterials = data ? data.map(item => ({
                    id: item.materials.id,
                    Description: item.materials.description
                })) : [];

                appState = 'MATERIALS';
                render();
                
                const count = productMaterials.length;
                console.log(`‚úÖ ${count} material${count !== 1 ? 'es' : ''} encontrado${count !== 1 ? 's' : ''}:`, productMaterials);
            } catch (error) {
                console.error('Error cargando materiales:', error);
                productMaterials = [];
                appState = 'MATERIALS';
                render();
                showNotification('Error cargando materiales', 'error');
            }
        }

        // --- INICIALIZACI√ìN ---
        function hideSplashScreen() {
            const splash = document.getElementById('splash-screen');
            if (splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.remove(), 500);
            }
        }

        async function initApp() {
            console.log('üöÄ Inicializando aplicaci√≥n con Design System v3.0...');
            
            // Inicializar Design System
            iconManager = new IconManager();
            button = Button;
            card = Card;
            header = Header;
            
            // Inicializar ViewManager
            viewManager = new ViewManager(APP_CONFIG);
            
            // Crear instancia del esc√°ner
            scanner = new ScannerModule();
            
            // Configurar callbacks del scanner
            scanner.setCallbacks({
                onScanSuccess: (decodedText, decodedResult) => {
                    console.log('üéØ Escaneo exitoso con:', decodedResult.engine || 'motor desconocido');
                    searchProduct(decodedText);
                },
                onScanError: (error, message) => {
                    if (message.includes('adblocker') || message.includes('conexi√≥n') || message.includes('permisos')) {
                        showNotification(message, 'error');
                    }
                },
                onStatusUpdate: (message) => {
                    const statusElement = document.getElementById('scanner-status');
                    if (statusElement) {
                        statusElement.textContent = message;
                    }
                },
                onPermissionChange: (status) => {
                    console.log('Permisos cambiaron a:', status);
                    if (appState === 'SCANNER') {
                        render();
                    }
                }
            });
            
            // Verificar permisos persistentes
            await scanner.checkPersistedPermissions();
            
            // Ocultar splash screen y mostrar app
            setTimeout(hideSplashScreen, 1500);
            render();
            
            // Configurar event listeners
            document.addEventListener('click', handleEvents);
            document.addEventListener('submit', handleEvents);
            
            window.addEventListener('popstate', () => {
                stopScanner();
                appState = 'HOME';
                render();
            });
            
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopScanner();
                }
            });
            
            window.addEventListener('beforeunload', () => {
                if (scanner) {
                    scanner.destroy();
                }
            });
            
            console.log('‚úÖ Aplicaci√≥n inicializada con Design System v3.0');
            
            // Debug info mejorado
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                console.log('üõ†Ô∏è MODO DEBUG ACTIVADO');
                
                setTimeout(async () => {
                    try {
                        const engineInfo = scanner.getEngineInfo();
                        if (engineInfo) {
                            console.log('üîß Motor de escaneo:', engineInfo.name);
                            console.log('‚ö° Rendimiento:', engineInfo.performance);
                            console.log('üé® Design System v3.0 activo');
                            console.log('üì± Icons disponibles:', iconManager.list());
                        }
                    } catch (e) {
                        console.log('‚ÑπÔ∏è Informaci√≥n del motor disponible despu√©s de la primera inicializaci√≥n');
                    }
                }, 2000);
                
                // Funci√≥n de debug global
                window.debugMegaScan = () => {
                    console.log('=== üõ†Ô∏è MEGA SCAN DEBUG INFO v3.0 ===');
                    console.log('Motor actual:', scanner.getEngineInfo());
                    console.log('Estado:', scanner.getStatus());
                    console.log('Estad√≠sticas:', scanner.getDetailedStats());
                    console.log('Design System:', {
                        iconManager: iconManager,
                        availableIcons: iconManager.list(),
                        components: { button, card, header }
                    });
                    console.log('=== FIN DEBUG INFO ===');
                };
                
                console.log('üí° Tip: Ejecuta debugMegaScan() en consola para informaci√≥n completa');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>